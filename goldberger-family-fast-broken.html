<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goldberger Family - Fast Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #2d3748;
            line-height: 1.6;
        }
        
        /* ===== SIDEBAR LAYOUT ===== */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            padding: 30px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
        }

        .sidebar-header {
            padding: 0 30px 30px 30px;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 30px;
        }

        .sidebar-title {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .sidebar-subtitle {
            font-size: 0.9rem;
            color: #718096;
            font-weight: 400;
        }

        .nav-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .nav-item {
            margin-bottom: 5px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 15px 30px;
            color: #4a5568;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .nav-link:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border-left-color: #667eea;
        }

        .nav-link.active {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            color: #667eea;
            border-left-color: #667eea;
        }

        .nav-icon {
            font-size: 1.2rem;
            margin-right: 12px;
            width: 20px;
            text-align: center;
        }

        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .content-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .content-title {
            font-size: 2rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .content-subtitle {
            font-size: 1.1rem;
            color: #718096;
            font-weight: 400;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1rem;
            color: #718096;
            font-weight: 400;
        }
        
        .section { 
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s ease;
        }
        
        .section:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.12);
        }
        
        .section h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); 
            gap: 25px; 
        }
        
        /* ===== ZEBRA TABLE STYLES ===== */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            text-align: left;
            font-weight: 600;
            font-size: 0.95rem;
            border: none;
        }

        .data-table td {
            padding: 12px 20px;
            border-bottom: 1px solid rgba(226, 232, 240, 0.5);
            font-size: 0.9rem;
            color: #4a5568;
        }

        .data-table tr:nth-child(even) {
            background: rgba(247, 250, 252, 0.5);
        }

        .data-table tr:nth-child(odd) {
            background: rgba(255, 255, 255, 0.8);
        }

        .data-table tr:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.01);
            transition: all 0.2s ease;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .table-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .table-actions .btn {
            padding: 6px 12px;
            font-size: 0.8rem;
            margin: 0;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: rgba(72, 187, 120, 0.2);
            color: #38a169;
        }

        .status-inactive {
            background: rgba(245, 101, 101, 0.2);
            color: #e53e3e;
        }

                 .status-paused {
             background: rgba(237, 137, 54, 0.2);
             color: #dd6b20;
         }
         
         .status-paid {
             background: rgba(72, 187, 120, 0.2);
             color: #38a169;
         }
         
         .status-pending {
             background: rgba(214, 158, 46, 0.2);
             color: #d69e2e;
         }
         
         .status-overdue {
             background: rgba(245, 101, 101, 0.2);
             color: #e53e3e;
         }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #718096;
            font-style: italic;
        }
        
        .btn { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 12px; 
            cursor: pointer; 
            margin: 8px 8px 8px 0;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success { 
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
        }
        
        .btn-success:hover {
            box-shadow: 0 6px 20px rgba(72, 187, 120, 0.4);
        }
        
        .btn-warning { 
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(237, 137, 54, 0.3);
        }
        
        .btn-warning:hover {
            box-shadow: 0 6px 20px rgba(237, 137, 54, 0.4);
        }
        
        .btn-danger { 
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            box-shadow: 0 4px 15px rgba(245, 101, 101, 0.3);
        }
        
        .btn-danger:hover {
            box-shadow: 0 6px 20px rgba(245, 101, 101, 0.4);
        }
        
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 500;
            color: #2d3748;
            font-size: 0.95rem;
        }
        
        .form-group input, .form-group select { 
            width: 100%; 
            padding: 12px 16px; 
            border: 2px solid #e2e8f0; 
            border-radius: 12px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.9);
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        
        
        .hidden { 
            display: none; 
        }
        
        .stats { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        
        .stat-card { 
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.12);
        }
        
        .stat-number { 
            font-size: 2.5rem; 
            font-weight: 700; 
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }
        
        .stat-label { 
            color: #718096; 
            font-weight: 500;
            font-size: 1rem;
        }
        
        /* Icons */
        .icon {
            font-size: 1.3rem;
            margin-right: 8px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                padding: 20px 15px;
            }
            
            .content-header {
                padding: 20px;
            }
            
            .content-title {
                font-size: 1.5rem;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .mobile-menu-toggle {
                display: block;
                position: fixed;
                top: 20px;
                left: 20px;
                z-index: 200;
                background: rgba(255, 255, 255, 0.95);
                border: none;
                padding: 10px;
                border-radius: 8px;
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            }
        }

        .mobile-menu-toggle {
            display: none;
        }
        
        /* Loading animation */
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
        
        /* Success animation */
        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .success-animation {
            animation: successPulse 0.5s ease;
        }

        /* ===== POPUP MODAL STYLES ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transform: scale(0.8) translateY(-20px);
            transition: all 0.3s ease;
            position: relative;
        }

        .modal.active {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2d3748;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #718096;
            padding: 5px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: #f7fafc;
            color: #2d3748;
        }

        .modal-body {
            margin-bottom: 25px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal .form-group {
            margin-bottom: 20px;
        }

        .modal .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2d3748;
            font-size: 0.95rem;
        }

        .modal .form-group input,
        .modal .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
        }

        .modal .form-group input:focus,
        .modal .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Animation for modal entrance */
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal.animate-in {
            animation: modalSlideIn 0.3s ease forwards;
        }

        /* Enhanced form validation styles */
        .form-group input:invalid,
        .form-group select:invalid {
            border-color: #f56565;
        }

        .form-group input:valid,
        .form-group select:valid {
            border-color: #48bb78;
        }

        /* Loading state for buttons */
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Enhanced modal animations */
        .modal-overlay.active .modal {
            animation: modalSlideIn 0.4s ease forwards;
        }

                 /* Success message styling */
         .success-message {
             background: linear-gradient(135deg, #48bb78, #38a169);
             color: white;
             padding: 15px 20px;
             border-radius: 12px;
             margin-bottom: 20px;
             text-align: center;
             font-weight: 500;
             animation: fadeInUp 0.5s ease;
         }
         
         /* Required field styling */
         .form-group input:required {
             border-left: 3px solid #e53e3e;
         }
         
         .form-group input:required:valid {
             border-left: 3px solid #48bb78;
         }
         
         .form-group input:required:invalid {
             border-left: 3px solid #e53e3e;
         }

                 @keyframes fadeInUp {
             from {
                 opacity: 0;
                 transform: translateY(20px);
             }
             to {
                 opacity: 1;
                 transform: translateY(0);
             }
         }

         /* ===== LOGIN SCREEN STYLES ===== */
         .login-screen {
             position: fixed;
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
             background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
             display: flex;
             justify-content: center;
             align-items: center;
             z-index: 9999;
         }

         .login-container {
             background: rgba(255, 255, 255, 0.95);
             backdrop-filter: blur(20px);
             border-radius: 20px;
             padding: 40px;
             max-width: 400px;
             width: 90%;
             box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
             border: 1px solid rgba(255, 255, 255, 0.2);
         }

         .login-header {
             text-align: center;
             margin-bottom: 30px;
         }

         .login-header h1 {
             font-size: 2rem;
             font-weight: 700;
             background: linear-gradient(135deg, #667eea, #764ba2);
             -webkit-background-clip: text;
             -webkit-text-fill-color: transparent;
             margin-bottom: 8px;
         }

         .login-header p {
             color: #718096;
             font-size: 1rem;
         }

         .login-form .form-group {
             margin-bottom: 20px;
         }

         .login-form .form-group label {
             display: block;
             margin-bottom: 8px;
             font-weight: 500;
             color: #2d3748;
         }

         .login-form .form-group input {
             width: 100%;
             padding: 12px 16px;
             border: 2px solid #e2e8f0;
             border-radius: 12px;
             font-size: 1rem;
             transition: all 0.3s ease;
             background: rgba(255, 255, 255, 0.9);
         }

         .login-form .form-group input:focus {
             outline: none;
             border-color: #667eea;
             box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
         }

         .login-help {
             margin-top: 30px;
             padding: 20px;
             background: rgba(102, 126, 234, 0.1);
             border-radius: 12px;
             border-left: 4px solid #667eea;
         }

         .login-help h4 {
             color: #667eea;
             margin-bottom: 10px;
             font-size: 0.9rem;
         }

         .login-help p {
             font-size: 0.8rem;
             color: #4a5568;
             margin-bottom: 5px;
         }

         /* User info in sidebar */
         .user-info {
             padding: 20px 30px;
             border-bottom: 2px solid #e2e8f0;
             margin-bottom: 20px;
         }

         .user-name {
             font-weight: 600;
             color: #2d3748;
             margin-bottom: 5px;
         }

         .user-role {
             font-size: 0.8rem;
             color: #718096;
             text-transform: uppercase;
             font-weight: 500;
         }

         .logout-btn {
             background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
             color: white;
             border: none;
             padding: 8px 16px;
             border-radius: 8px;
             cursor: pointer;
             font-size: 0.8rem;
             margin-top: 10px;
             width: 100%;
             transition: all 0.3s ease;
         }

         .logout-btn:hover {
             transform: translateY(-1px);
             box-shadow: 0 4px 12px rgba(245, 101, 101, 0.3);
         }
     </style>
</head>
<body>
         <!-- ===== LOGIN SCREEN ===== -->
     <div id="loginScreen" class="login-screen">
         <div class="login-container">
             <div class="login-header">
                 <h1>üè† Goldberger Family</h1>
                 <p>Secure Family Dashboard</p>
             </div>
             <div class="login-form">
                 <div class="form-group">
                     <label>Email:</label>
                     <input type="email" id="loginEmail" placeholder="Enter your email" required>
                 </div>
                 <div class="form-group">
                     <label>Password:</label>
                     <input type="password" id="loginPassword" placeholder="Enter your password" required>
                 </div>
                 <button class="btn btn-success" onclick="login()" style="width: 100%; margin-top: 20px;">Login</button>
                 
                 <button class="btn btn-warning" onclick="resetDataWithPasswords()" style="width: 100%; margin-top: 10px; font-size: 0.8rem;">Reset Data (if login fails)</button>
                 
                 <div class="login-help">
                     <h4>Demo Accounts:</h4>
                     <p><strong>Super Admin:</strong> test@example.com / admin123</p>
                     <p><strong>Admin:</strong> admin@example.com / admin456</p>
                     <p><strong>Member:</strong> test@gmail.com / member123</p>
                 </div>
             </div>
         </div>
     </div>

     <div class="app-container" id="mainApp" style="display: none;">
         <!-- Mobile Menu Toggle -->
         <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
             <span class="nav-icon">‚ò∞</span>
         </button>

                 <!-- Sidebar -->
         <div class="sidebar" id="sidebar">
             <div class="sidebar-header">
                 <div class="sidebar-title">üè† Goldberger</div>
                 <div class="sidebar-subtitle">Family Dashboard</div>
             </div>
             
             <!-- User Info -->
             <div class="user-info">
                 <div class="user-name" id="currentUserName">Loading...</div>
                 <div class="user-role" id="currentUserRole">Loading...</div>
                 <button class="logout-btn" onclick="logout()">Logout</button>
             </div>
            
            
             
             <nav class="nav-menu">
                 <div class="nav-item">
                     <a href="#" class="nav-link active" onclick="showSection('overview')">
                         <span class="nav-icon">üìä</span>
                         Overview
                     </a>
                 </div>
                 <div class="nav-item">
                     <a href="#" class="nav-link" onclick="showSection('family')">
                         <span class="nav-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span>
                         Family Info
                     </a>
                 </div>
                 <div class="nav-item">
                     <a href="#" class="nav-link" onclick="showSection('members')">
                         <span class="nav-icon">üë•</span>
                         Members
                     </a>
                 </div>
                 <div class="nav-item">
                     <a href="#" class="nav-link" onclick="showSection('subscriptions')">
                         <span class="nav-icon">üí≥</span>
                         Subscriptions
                     </a>
                 </div>
                                  <div class="nav-item">
                      <a href="#" class="nav-link" onclick="showSection('pricing')">
                          <span class="nav-icon">üí∞</span>
                          Pricing Plans
                      </a>
                  </div>
                                     <div class="nav-item">
                       <a href="#" class="nav-link" onclick="showSection('statements')">
                           <span class="nav-icon">üìÑ</span>
                           Statements
                       </a>
                   </div>
                   ${currentUser && currentUser.role === 'super_admin' ? `
                   <div class="nav-item">
                       <a href="#" class="nav-link" onclick="showSection('families')">
                           <span class="nav-icon">üè†</span>
                           Families
                       </a>
                   </div>
                   ` : ''}
             </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Overview Section -->
            <div id="overview-section" class="content-section">
                <div class="content-header">
                    <h1 class="content-title">üìä Dashboard Overview</h1>
                    <p class="content-subtitle">Lightning Fast - All Data in Memory</p>
                </div>

                <!-- Stats Overview -->
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalMembers">0</div>
                        <div class="stat-label">Family Members</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="activeSubscriptions">0</div>
                        <div class="stat-label">Active Subscriptions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalStatements">0</div>
                        <div class="stat-label">Total Statements</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalRevenue">$0</div>
                        <div class="stat-label">Total Revenue</div>
                    </div>
                </div>

                <div class="grid">
                    <!-- Quick Actions -->
                                         <div class="section">
                         <h2><span class="icon">‚ö°</span>Quick Actions</h2>
                         <div id="quickActions" style="display: flex; gap: 10px; flex-wrap: wrap;">
                             <!-- Quick actions will be populated by JavaScript -->
                         </div>
                     </div>

                    <!-- Recent Activity -->
                    <div class="section">
                        <h2><span class="icon">üïí</span>Recent Activity</h2>
                        <div id="recentActivity">
                            <p>No recent activity</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Family Info Section -->
            <div id="family-section" class="content-section" style="display: none;">
                <div class="content-header">
                    <h1 class="content-title">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Information</h1>
                    <p class="content-subtitle">Manage your family details</p>
                </div>
                                 <div class="section">
                     <div id="familyInfo"></div>
                     <div id="familyActions"></div>
                 </div>
            </div>

            <!-- Members Section -->
            <div id="members-section" class="content-section" style="display: none;">
                <div class="content-header">
                    <h1 class="content-title">üë• Family Members</h1>
                    <p class="content-subtitle">Manage family members and their roles</p>
                </div>
                                 <div class="section">
                     <div id="membersList"></div>
                     <div id="membersActions"></div>
                 </div>
            </div>

                         <!-- Subscriptions Section -->
             <div id="subscriptions-section" class="content-section" style="display: none;">
                 <div class="content-header">
                     <h1 class="content-title">üí≥ Subscriptions</h1>
                     <p class="content-subtitle">Manage family subscriptions and billing</p>
                 </div>
                                   <div class="section">
                      <div id="subscriptionsList"></div>
                      <div id="subscriptionsActions"></div>
                  </div>
             </div>

             <!-- Pricing Plans Section -->
             <div id="pricing-section" class="content-section" style="display: none;">
                 <div class="content-header">
                     <h1 class="content-title">üí∞ Pricing Plans</h1>
                     <p class="content-subtitle">Manage subscription pricing plans</p>
                 </div>
                                   <div class="section">
                      <div id="pricingList"></div>
                      <div id="pricingActions"></div>
                  </div>
             </div>

                         <!-- Statements Section -->
             <div id="statements-section" class="content-section" style="display: none;">
                 <div class="content-header">
                     <h1 class="content-title">üìÑ Statements</h1>
                     <p class="content-subtitle">View and manage monthly statements</p>
                 </div>
                 <div class="section">
                     <div id="statementsList"></div>
                     <div id="statementsActions"></div>
                 </div>
             </div>

             <!-- Families Section (Super Admin Only) -->
             <div id="families-section" class="content-section" style="display: none;">
                 <div class="content-header">
                     <h1 class="content-title">üè† Families Management</h1>
                     <p class="content-subtitle">Manage all families and create new family dashboards</p>
                 </div>
                 <div class="section">
                     <div id="familiesList"></div>
                     <div id="familiesActions"></div>
                 </div>
             </div>
        </div>
    </div>

    <!-- ===== POPUP MODALS ===== -->
    <div id="editFamilyModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">‚úèÔ∏è Edit Family</h3>
                <button class="modal-close" onclick="closeModal('editFamilyModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Family Name:</label>
                    <input type="text" id="editFamilyName" placeholder="Enter family name">
                </div>
                <div class="form-group">
                    <label>Address:</label>
                    <input type="text" id="editFamilyAddress" placeholder="Enter address">
                </div>
                <div class="form-group">
                    <label>Phone:</label>
                    <input type="tel" id="editFamilyPhone" placeholder="Enter phone number">
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="editFamilyEmail" placeholder="Enter email address">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="closeModal('editFamilyModal')">Cancel</button>
                <button class="btn btn-success" onclick="saveFamilyChanges()">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="editMemberModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">üë§ Edit Member</h3>
                <button class="modal-close" onclick="closeModal('editMemberModal')">&times;</button>
            </div>
            <div class="modal-body">
                                 <div class="form-group">
                     <label>First Name: <span style="color: #e53e3e;">*</span></label>
                     <input type="text" id="editMemberFirstName" placeholder="Enter first name" required>
                 </div>
                 <div class="form-group">
                     <label>Last Name: <span style="color: #e53e3e;">*</span></label>
                     <input type="text" id="editMemberLastName" placeholder="Enter last name" required>
                 </div>
                 <div class="form-group">
                     <label>Email: <span style="color: #e53e3e;">*</span></label>
                     <input type="email" id="editMemberEmail" placeholder="Enter email address" required>
                 </div>
                 <div class="form-group">
                     <label>Phone: <span style="color: #e53e3e;">*</span></label>
                     <input type="tel" id="editMemberPhone" placeholder="Enter phone number" required>
                 </div>
                                 <div class="form-group">
                     <label>Role:</label>
                     <select id="editMemberRole">
                         <option value="member">Member</option>
                         <option value="admin">Admin</option>
                         <option value="super_admin">Super Admin</option>
                     </select>
                 </div>
                 <div class="form-group">
                     <label>Pricing Plan:</label>
                     <select id="editMemberPricingPlan">
                         <option value="">Select a pricing plan (optional)</option>
                     </select>
                 </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="closeModal('editMemberModal')">Cancel</button>
                <button class="btn btn-success" onclick="saveMemberChanges()">Save Changes</button>
            </div>
        </div>
    </div>

         <div id="editSubscriptionModal" class="modal-overlay">
         <div class="modal">
             <div class="modal-header">
                 <h3 class="modal-title">üí≥ Edit Subscription</h3>
                 <button class="modal-close" onclick="closeModal('editSubscriptionModal')">&times;</button>
             </div>
             <div class="modal-body">
                 <div class="form-group">
                     <label>Status:</label>
                     <select id="editSubscriptionStatus">
                         <option value="active">Active</option>
                         <option value="inactive">Inactive</option>
                         <option value="paused">Paused</option>
                     </select>
                 </div>
                 <div class="form-group">
                     <label>Monthly Amount:</label>
                     <input type="text" id="editSubscriptionAmount" placeholder="Enter monthly amount" oninput="formatCurrency(this)" onblur="validateCurrency(this)">
                 </div>
             </div>
             <div class="modal-footer">
                 <button class="btn btn-danger" onclick="closeModal('editSubscriptionModal')">Cancel</button>
                 <button class="btn btn-success" onclick="saveSubscriptionChanges()">Save Changes</button>
             </div>
         </div>
     </div>

     <div id="editStatementModal" class="modal-overlay">
         <div class="modal">
             <div class="modal-header">
                 <h3 class="modal-title">üìÑ Edit Statement</h3>
                 <button class="modal-close" onclick="closeModal('editStatementModal')">&times;</button>
             </div>
             <div class="modal-body">
                 <div class="form-group">
                     <label>Status:</label>
                     <select id="editStatementStatus">
                         <option value="pending">Pending</option>
                         <option value="paid">Paid</option>
                         <option value="overdue">Overdue</option>
                     </select>
                 </div>
                 <div class="form-group">
                     <label>Amount:</label>
                     <input type="text" id="editStatementAmount" placeholder="Enter amount" oninput="formatCurrency(this)" onblur="validateCurrency(this)">
                 </div>
                 <div class="form-group">
                     <label>Billing Date:</label>
                     <input type="date" id="editStatementBillingDate">
                 </div>
                 <div class="form-group">
                     <label>Due Date:</label>
                     <input type="date" id="editStatementDueDate">
                 </div>
             </div>
             <div class="modal-footer">
                 <button class="btn btn-danger" onclick="closeModal('editStatementModal')">Cancel</button>
                 <button class="btn btn-success" onclick="saveStatementChanges()">Save Changes</button>
             </div>
         </div>
     </div>

    <!-- ===== ADD MEMBER POPUP MODAL ===== -->
    <div id="addMemberModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">‚ûï Add New Member</h3>
                <button class="modal-close" onclick="closeModal('addMemberModal')">&times;</button>
            </div>
            <div class="modal-body">
                                 <div class="form-group">
                     <label>First Name: <span style="color: #e53e3e;">*</span></label>
                     <input type="text" id="addMemberFirstName" placeholder="Enter first name" required>
                 </div>
                 <div class="form-group">
                     <label>Last Name: <span style="color: #e53e3e;">*</span></label>
                     <input type="text" id="addMemberLastName" placeholder="Enter last name" required>
                 </div>
                 <div class="form-group">
                     <label>Email: <span style="color: #e53e3e;">*</span></label>
                     <input type="email" id="addMemberEmail" placeholder="Enter email address" required>
                 </div>
                 <div class="form-group">
                     <label>Phone: <span style="color: #e53e3e;">*</span></label>
                     <input type="tel" id="addMemberPhone" placeholder="Enter phone number" required>
                 </div>
                                 <div class="form-group">
                     <label>Role:</label>
                     <select id="addMemberRole">
                         <option value="member">Member</option>
                         <option value="admin">Admin</option>
                         <option value="super_admin">Super Admin</option>
                     </select>
                 </div>
                 <div class="form-group">
                     <label>Pricing Plan:</label>
                     <select id="addMemberPricingPlan">
                         <option value="">Select a pricing plan (optional)</option>
                     </select>
                 </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="closeModal('addMemberModal')">Cancel</button>
                <button class="btn btn-success" onclick="saveNewMember()">Add Member</button>
            </div>
        </div>
    </div>

         <!-- ===== ADD SUBSCRIPTION POPUP MODAL ===== -->
     <div id="addSubscriptionModal" class="modal-overlay">
         <div class="modal">
             <div class="modal-header">
                 <h3 class="modal-title">üí≥ Add Subscription</h3>
                 <button class="modal-close" onclick="closeModal('addSubscriptionModal')">&times;</button>
             </div>
             <div class="modal-body">
                 <div class="form-group">
                     <label>Member:</label>
                     <select id="addSubscriptionMember"></select>
                 </div>
                 <div class="form-group">
                     <label>Price Plan:</label>
                     <select id="addSubscriptionPlan"></select>
                 </div>
                 <div class="form-group">
                     <label>Start Date:</label>
                     <input type="date" id="addSubscriptionStartDate">
                 </div>
             </div>
             <div class="modal-footer">
                 <button class="btn btn-danger" onclick="closeModal('addSubscriptionModal')">Cancel</button>
                 <button class="btn btn-success" onclick="saveNewSubscription()">Add Subscription</button>
             </div>
         </div>
     </div>

     <!-- ===== ADD PRICING PLAN MODAL ===== -->
     <div id="addPricingModal" class="modal-overlay">
         <div class="modal">
             <div class="modal-header">
                 <h3 class="modal-title">üí∞ Add Pricing Plan</h3>
                 <button class="modal-close" onclick="closeModal('addPricingModal')">&times;</button>
             </div>
             <div class="modal-body">
                 <div class="form-group">
                     <label>Plan Title:</label>
                     <input type="text" id="addPricingTitle" placeholder="Enter plan title">
                 </div>
                 <div class="form-group">
                     <label>Description:</label>
                     <input type="text" id="addPricingDescription" placeholder="Enter plan description">
                 </div>
                 <div class="form-group">
                     <label>Yearly Price ($):</label>
                     <input type="text" id="addPricingYearlyPrice" placeholder="Enter yearly price" oninput="formatCurrency(this)" onblur="validateCurrency(this)">
                 </div>
                 <div class="form-group">
                     <label>Monthly Price ($):</label>
                     <input type="text" id="addPricingMonthlyPrice" placeholder="Enter monthly price" oninput="formatCurrency(this)" onblur="validateCurrency(this)">
                 </div>
                 <div class="form-group">
                     <label>Features (comma separated):</label>
                     <input type="text" id="addPricingFeatures" placeholder="Feature 1, Feature 2, Feature 3">
                 </div>
                 <div class="form-group">
                     <label>Status:</label>
                     <select id="addPricingStatus">
                         <option value="active">Active</option>
                         <option value="inactive">Inactive</option>
                     </select>
                 </div>
             </div>
             <div class="modal-footer">
                 <button class="btn btn-danger" onclick="closeModal('addPricingModal')">Cancel</button>
                 <button class="btn btn-success" onclick="saveNewPricing()">Add Plan</button>
             </div>
         </div>
     </div>

     <!-- ===== EDIT PRICING PLAN MODAL ===== -->
     <div id="editPricingModal" class="modal-overlay">
         <div class="modal">
             <div class="modal-header">
                 <h3 class="modal-title">üí∞ Edit Pricing Plan</h3>
                 <button class="modal-close" onclick="closeModal('editPricingModal')">&times;</button>
             </div>
             <div class="modal-body">
                 <div class="form-group">
                     <label>Plan Title:</label>
                     <input type="text" id="editPricingTitle" placeholder="Enter plan title">
                 </div>
                 <div class="form-group">
                     <label>Description:</label>
                     <input type="text" id="editPricingDescription" placeholder="Enter plan description">
                 </div>
                 <div class="form-group">
                     <label>Yearly Price ($):</label>
                     <input type="text" id="editPricingYearlyPrice" placeholder="Enter yearly price" oninput="formatCurrency(this)" onblur="validateCurrency(this)">
                 </div>
                 <div class="form-group">
                     <label>Monthly Price ($):</label>
                     <input type="text" id="editPricingMonthlyPrice" placeholder="Enter monthly price" oninput="formatCurrency(this)" onblur="validateCurrency(this)">
                 </div>
                 <div class="form-group">
                     <label>Features (comma separated):</label>
                     <input type="text" id="editPricingFeatures" placeholder="Feature 1, Feature 2, Feature 3">
                 </div>
                 <div class="form-group">
                     <label>Status:</label>
                     <select id="editPricingStatus">
                         <option value="active">Active</option>
                         <option value="inactive">Inactive</option>
                     </select>
                 </div>
             </div>
             <div class="modal-footer">
                 <button class="btn btn-danger" onclick="closeModal('editPricingModal')">Cancel</button>
                 <button class="btn btn-success" onclick="savePricingChanges()">Save Changes</button>
             </div>
         </div>
     </div>

           <!-- ===== ADD FAMILY MODAL ===== -->
      <div id="addFamilyModal" class="modal-overlay">
          <div class="modal">
              <div class="modal-header">
                  <h3 class="modal-title">üè† Create New Family</h3>
                  <button class="modal-close" onclick="closeModal('addFamilyModal')">&times;</button>
              </div>
              <div class="modal-body">
                  <div class="form-group">
                      <label>Family Name: <span style="color: #e53e3e;">*</span></label>
                      <input type="text" id="addFamilyName" placeholder="Enter family name" required>
                  </div>
                  <div class="form-group">
                      <label>Address:</label>
                      <input type="text" id="addFamilyAddress" placeholder="Enter family address">
                  </div>
                  <div class="form-group">
                      <label>Phone:</label>
                      <input type="tel" id="addFamilyPhone" placeholder="Enter family phone">
                  </div>
                  <div class="form-group">
                      <label>Email:</label>
                      <input type="email" id="addFamilyEmail" placeholder="Enter family email">
                  </div>
                  <div class="form-group">
                      <label>Super Admin Email: <span style="color: #e53e3e;">*</span></label>
                      <input type="email" id="addFamilyAdminEmail" placeholder="Enter super admin email" required>
                  </div>
                  <div class="form-group">
                      <label>Super Admin Password: <span style="color: #e53e3e;">*</span></label>
                      <input type="password" id="addFamilyAdminPassword" placeholder="Enter super admin password" required>
                  </div>
              </div>
              <div class="modal-footer">
                  <button class="btn btn-danger" onclick="closeModal('addFamilyModal')">Cancel</button>
                  <button class="btn btn-success" onclick="createNewFamily()">Create Family</button>
              </div>
          </div>
      </div>

      <!-- ===== DELETE CONFIRMATION MODAL ===== -->
      <div id="deleteConfirmModal" class="modal-overlay">
          <div class="modal">
              <div class="modal-header">
                  <h3 class="modal-title">üóëÔ∏è Confirm Delete</h3>
                  <button class="modal-close" onclick="closeModal('deleteConfirmModal')">&times;</button>
              </div>
              <div class="modal-body">
                  <div class="form-group">
                      <p id="deleteConfirmMessage">Are you sure you want to delete this item?</p>
                      <p style="color: #e53e3e; font-size: 0.9rem; margin-top: 10px;">
                          <strong>‚ö†Ô∏è Warning:</strong> This action cannot be undone.
                      </p>
                  </div>
              </div>
              <div class="modal-footer">
                  <button class="btn btn-warning" onclick="closeModal('deleteConfirmModal')">Cancel</button>
                  <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
              </div>
          </div>
      </div>

    <script>
                                   // ===== LIGHTNING FAST IN-MEMORY DATA WITH AUTO-SAVE =====
          // All data stored in memory for instant access (0ms response time) + localStorage persistence
          
          // Global families data (for Super Admin)
          let allFamilies = [
              {
                  id: "e40e4a183dfd346e6b4705504e36c78a",
                  name: "Goldberger Family",
                  address: "123 Main St",
                  phone: "+1234567890",
                  email: "family@example.com",
                  adminEmail: "test@example.com",
                  adminPassword: "admin123",
                  fileName: "goldberger-family-fast.html",
                  createdAt: "2025-08-22T16:09:24.793Z",
                  isActive: true
              }
          ];
          
          let familyData = {
              family: {
                  id: "e40e4a183dfd346e6b4705504e36c78a",
                  name: "Goldberger Family",
                  address: "123 Main St",
                  phone: "+1234567890",
                  email: "family@example.com",
                  createdAt: "2025-08-22T16:09:24.793Z"
              },
              members: [
                  {
                      id: "7fdd0798f880c9c3267f7e2546273b4c",
                      firstName: "Test",
                      lastName: "Admin",
                      email: "test@example.com",
                      phone: "+1234567890",
                      role: "super_admin",
                      password: "admin123", // Simple password for demo
                      balance: 0,
                      isActive: true,
                      createdAt: "2025-08-22T16:08:59.954Z"
                  },
                  {
                      id: "joel123",
                      firstName: "Joel",
                      lastName: "Goldberger",
                      email: "test@gmail.com",
                      phone: "8454679683",
                      role: "member",
                      password: "member123", // Simple password for demo
                      pricingPlanId: "plan1",
                      balance: 0,
                      isActive: true,
                      createdAt: "2025-08-25T14:30:00.000Z"
                  },
                  {
                      id: "admin456",
                      firstName: "Family",
                      lastName: "Admin",
                      email: "admin@example.com",
                      phone: "+1987654321",
                      role: "admin",
                      password: "admin456", // Simple password for demo
                      balance: 0,
                      isActive: true,
                      createdAt: "2025-08-25T15:00:00.000Z"
                  }
              ],
             pricePlans: [
                 {
                     id: "plan1",
                     title: "Basic Family Plan",
                     description: "Monthly family subscription",
                     yearlyPrice: 1200,
                     monthlyPrice: 100,
                     features: ["Family access", "Monthly statements", "Payment tracking"],
                     isActive: true
                 },
                 {
                     id: "plan2", 
                     title: "Premium Family Plan",
                     description: "Enhanced family features",
                     yearlyPrice: 2400,
                     monthlyPrice: 200,
                     features: ["All Basic features", "Priority support", "Advanced analytics"],
                     isActive: true
                 }
             ],
             subscriptions: [],
             statements: [],
             activities: []
         };
 
         // ===== AUTO-SAVE FUNCTIONS =====
         function saveToLocalStorage() {
             try {
                 localStorage.setItem('familyData', JSON.stringify(familyData));
                 console.log('üíæ Data auto-saved to localStorage');
             } catch (error) {
                 console.error('Error saving to localStorage:', error);
             }
         }
         
         function loadFromLocalStorage() {
             try {
                 const savedData = localStorage.getItem('familyData');
                 if (savedData) {
                     familyData = JSON.parse(savedData);
                     console.log('üìÇ Data loaded from localStorage');
                     return true;
                 }
             } catch (error) {
                 console.error('Error loading from localStorage:', error);
             }
             return false;
         }
         
                   // ===== AUTHENTICATION SYSTEM =====
          let currentUser = null;
          
          function login() {
              const email = document.getElementById('loginEmail').value.trim();
              const password = document.getElementById('loginPassword').value.trim();
              
              if (!email || !password) {
                  alert('Please enter both email and password');
                  return;
              }
              
              // Debug: Check if user exists
              const userByEmail = familyData.members.find(m => m.email === email);
              if (!userByEmail) {
                  alert('User not found with this email');
                  return;
              }
              
              // Find user by email and password
              const user = familyData.members.find(m => m.email === email && m.password === password);
              
              if (!user) {
                  alert('Invalid password. Please check your password.');
                  return;
              }
              
              if (!user.isActive) {
                  alert('Account is inactive. Please contact administrator.');
                  return;
              }
              
              // Set current user
              currentUser = user;
              
              // Save to localStorage
              localStorage.setItem('currentUser', JSON.stringify(user));
              
              // Hide login, show main app
              document.getElementById('loginScreen').style.display = 'none';
              document.getElementById('mainApp').style.display = 'flex';
              
              // Update user info in sidebar
              updateUserInfo();
              
              // Refresh display with role-based filtering
              refreshDisplay();
              showSection('overview');
              
              console.log(`üë§ Logged in as: ${user.firstName} ${user.lastName} (${user.role})`);
          }
          
          function logout() {
              currentUser = null;
              localStorage.removeItem('currentUser');
              
              // Show login, hide main app
              document.getElementById('loginScreen').style.display = 'flex';
              document.getElementById('mainApp').style.display = 'none';
              
              // Clear form
              document.getElementById('loginEmail').value = '';
              document.getElementById('loginPassword').value = '';
              
              console.log('üëã Logged out');
          }
          
          function updateUserInfo() {
              if (currentUser) {
                  document.getElementById('currentUserName').textContent = `${currentUser.firstName} ${currentUser.lastName}`;
                  document.getElementById('currentUserRole').textContent = currentUser.role.replace('_', ' ');
              }
          }
          
          function canViewAllData() {
              return currentUser && (currentUser.role === 'super_admin' || currentUser.role === 'admin');
          }
          
          function canEditData() {
              return currentUser && (currentUser.role === 'super_admin' || currentUser.role === 'admin');
          }
          
          function canDeleteData() {
              return currentUser && currentUser.role === 'super_admin';
          }
          
          function getFilteredMembers() {
              if (canViewAllData()) {
                  return familyData.members;
              } else {
                  // Members can only see themselves
                  return familyData.members.filter(m => m.id === currentUser.id);
              }
          }
          
          function getFilteredSubscriptions() {
              if (canViewAllData()) {
                  return familyData.subscriptions;
              } else {
                  // Members can only see their own subscriptions
                  return familyData.subscriptions.filter(s => s.memberId === currentUser.id);
              }
          }
          
          function getFilteredStatements() {
              if (canViewAllData()) {
                  return familyData.statements;
              } else {
                  // Members can only see their own statements
                  return familyData.statements.filter(s => s.memberId === currentUser.id);
              }
          }
          
          // Auto-save on every data change
          function autoSave() {
              saveToLocalStorage();
          }
          
          // Function to reset data and ensure passwords are set
          function resetDataWithPasswords() {
              // Clear localStorage
              localStorage.removeItem('familyData');
              localStorage.removeItem('currentUser');
              
              // Reload page to use default data with passwords
              location.reload();
          }
 
         // ===== CURRENCY FORMATTING FUNCTIONS =====
         function formatCurrency(input) {
             // Remove all non-numeric characters except decimal point
             let value = input.value.replace(/[^\d.]/g, '');
             
             // Ensure only one decimal point
             const parts = value.split('.');
             if (parts.length > 2) {
                 value = parts[0] + '.' + parts.slice(1).join('');
             }
             
             // Limit to 2 decimal places
             if (parts.length === 2 && parts[1].length > 2) {
                 value = parts[0] + '.' + parts[1].substring(0, 2);
             }
             
             // Format with commas for thousands
             if (value && value !== '.') {
                 const numValue = parseFloat(value);
                 if (!isNaN(numValue)) {
                     input.value = numValue.toLocaleString('en-US', {
                         minimumFractionDigits: 0,
                         maximumFractionDigits: 2
                     });
                 }
             }
         }
         
         function validateCurrency(input) {
             let value = input.value.replace(/[^\d.]/g, '');
             
             if (value && value !== '.') {
                 const numValue = parseFloat(value);
                 if (!isNaN(numValue) && numValue >= 0) {
                     // Format as currency
                     input.value = numValue.toLocaleString('en-US', {
                         style: 'currency',
                         currency: 'USD',
                         minimumFractionDigits: 2
                     });
                 } else {
                     input.value = '';
                 }
             } else if (value === '.') {
                 input.value = '';
             }
         }
         
         function parseCurrencyValue(value) {
             if (!value) return null;
             // Remove currency symbols and commas, then parse
             const cleanValue = value.replace(/[$,]/g, '');
             const numValue = parseFloat(cleanValue);
             return isNaN(numValue) ? null : numValue;
         }
         
         function formatPhoneNumber(phone) {
             // Remove all non-digit characters except +
             const cleaned = phone.replace(/[^\d+]/g, '');
             
             // If it starts with +, keep it
             if (cleaned.startsWith('+')) {
                 const number = cleaned.substring(1);
                 if (number.length === 10) {
                     return `+1 (${number.substring(0, 3)}) ${number.substring(3, 6)}-${number.substring(6)}`;
                 } else if (number.length === 11 && number.startsWith('1')) {
                     return `+1 (${number.substring(1, 4)}) ${number.substring(4, 7)}-${number.substring(7)}`;
                 }
                 return cleaned;
             }
             
             // US format: (XXX) XXX-XXXX
             if (cleaned.length === 10) {
                 return `(${cleaned.substring(0, 3)}) ${cleaned.substring(3, 6)}-${cleaned.substring(6)}`;
             }
             
             // If it's 11 digits and starts with 1, format as US
             if (cleaned.length === 11 && cleaned.startsWith('1')) {
                 return `+1 (${cleaned.substring(1, 4)}) ${cleaned.substring(4, 7)}-${cleaned.substring(7)}`;
             }
             
             // Return as is if no standard format matches
             return cleaned;
         }

         // ===== INSTANT FUNCTIONS (0ms response time) =====

                           function updateStats() {
              const filteredMembers = getFilteredMembers();
              const filteredSubscriptions = getFilteredSubscriptions();
              const filteredStatements = getFilteredStatements();
              
              document.getElementById('totalMembers').textContent = filteredMembers.length;
              document.getElementById('activeSubscriptions').textContent = filteredSubscriptions.filter(s => s.status === 'active').length;
              document.getElementById('totalStatements').textContent = filteredStatements.length;
              
              const totalRevenue = filteredStatements
                  .filter(s => s.status === 'paid')
                  .reduce((sum, s) => sum + s.amount, 0);
              document.getElementById('totalRevenue').textContent = `$${totalRevenue}`;
          }
          
          function updateQuickActions() {
              const quickActionsDiv = document.getElementById('quickActions');
              if (!quickActionsDiv) return;
              
              let actionsHtml = '';
              
              if (canEditData()) {
                  actionsHtml += '<button class="btn" onclick="showAddMemberForm()">‚ûï Add Member</button>';
                  actionsHtml += '<button class="btn" onclick="showAddSubscriptionForm()">üí≥ Add Subscription</button>';
                  actionsHtml += '<button class="btn" onclick="generateNextMonth()">üìÖ Generate Next Month</button>';
              }
              
              if (canViewAllData()) {
                  actionsHtml += '<button class="btn btn-success" onclick="exportData()">üì• Export Data</button>';
              }
              
              quickActionsDiv.innerHTML = actionsHtml;
          }
          
          // ===== FAMILIES MANAGEMENT FUNCTIONS =====
          function displayFamilies() {
              if (!currentUser || currentUser.role !== 'super_admin') {
                  document.getElementById('familiesList').innerHTML = '<div class="empty-state">Access denied. Super Admin only.</div>';
                  return;
              }
              
              if (allFamilies.length === 0) {
                  document.getElementById('familiesList').innerHTML = '<div class="empty-state">No families found</div>';
                  return;
              }
              
              const familiesHtml = `
                  <table class="data-table">
                      <thead>
                          <tr>
                              <th>Family Name</th>
                              <th>Address</th>
                              <th>Contact</th>
                              <th>Admin Email</th>
                              <th>Status</th>
                              <th>Created</th>
                              <th>Actions</th>
                          </tr>
                      </thead>
                      <tbody>
                          ${allFamilies.map(family => `
                              <tr>
                                  <td><strong>${family.name}</strong></td>
                                  <td>${family.address}</td>
                                  <td>${family.phone}<br>${family.email}</td>
                                  <td>${family.adminEmail}</td>
                                  <td><span class="status-badge ${family.isActive ? 'status-active' : 'status-inactive'}">${family.isActive ? 'Active' : 'Inactive'}</span></td>
                                  <td>${new Date(family.createdAt).toLocaleDateString()}</td>
                                  <td>
                                      <div class="table-actions">
                                          <button class="btn btn-success" onclick="openFamilyDashboard('${family.fileName}')">üöÄ Open</button>
                                          <button class="btn btn-warning" onclick="editFamily('${family.id}')">Edit</button>
                                          <button class="btn btn-danger" onclick="deleteFamily('${family.id}')">Delete</button>
                                      </div>
                                  </td>
                              </tr>
                          `).join('')}
                      </tbody>
                  </table>
              `;
              document.getElementById('familiesList').innerHTML = familiesHtml;
              
              // Update families actions
              const familiesActionsDiv = document.getElementById('familiesActions');
              if (familiesActionsDiv) {
                  familiesActionsDiv.innerHTML = '<button class="btn" onclick="showAddFamilyForm()">üè† Add New Family</button>';
              }
          }
          
          function showAddFamilyForm() {
              // Clear form fields
              document.getElementById('addFamilyName').value = '';
              document.getElementById('addFamilyAddress').value = '';
              document.getElementById('addFamilyPhone').value = '';
              document.getElementById('addFamilyEmail').value = '';
              document.getElementById('addFamilyAdminEmail').value = '';
              document.getElementById('addFamilyAdminPassword').value = '';
              
              openModal('addFamilyModal');
          }
          
          function createNewFamily() {
              const familyName = document.getElementById('addFamilyName').value.trim();
              const familyAddress = document.getElementById('addFamilyAddress').value.trim();
              const familyPhone = document.getElementById('addFamilyPhone').value.trim();
              const familyEmail = document.getElementById('addFamilyEmail').value.trim();
              const adminEmail = document.getElementById('addFamilyAdminEmail').value.trim();
              const adminPassword = document.getElementById('addFamilyAdminPassword').value.trim();
              
              // Validate required fields
              if (!familyName || !adminEmail || !adminPassword) {
                  alert('Please fill in all required fields (Family Name, Admin Email, Admin Password)');
                  return;
              }
              
              // Validate email format
              const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
              if (!emailRegex.test(adminEmail)) {
                  alert('Please enter a valid admin email address');
                  return;
              }
              
              // Generate unique ID and filename
              const familyId = generateId();
              const fileName = `${familyName.toLowerCase().replace(/[^a-z0-9]/g, '-')}-family.html`;
              
              // Create new family object
              const newFamily = {
                  id: familyId,
                  name: familyName,
                  address: familyAddress || 'Enter address',
                  phone: familyPhone || 'Enter phone',
                  email: familyEmail || 'Enter email',
                  adminEmail: adminEmail,
                  adminPassword: adminPassword,
                  fileName: fileName,
                  createdAt: new Date().toISOString(),
                  isActive: true
              };
              
              // Add to families list
              allFamilies.push(newFamily);
              
              // Generate HTML file content
              generateFamilyHTMLFile(newFamily);
              
              // Close modal and refresh
              closeModal('addFamilyModal');
              refreshDisplay();
              
              alert(`Family "${familyName}" created successfully!\nHTML file: ${fileName}`);
          }
          
          function generateFamilyHTMLFile(family) {
              // Create the HTML content for the new family
              const htmlContent = generateFamilyHTMLContent(family);
              
              // Create a download link for the HTML file
              const blob = new Blob([htmlContent], { type: 'text/html' });
              const url = URL.createObjectURL(blob);
              const link = document.createElement('a');
              link.href = url;
              link.download = family.fileName;
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              URL.revokeObjectURL(url);
          }
          
          function generateFamilyHTMLContent(family) {
              // This would generate a complete HTML file similar to the current one
              // but with the new family's data
              return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${family.name} - Fast Dashboard</title>
    <!-- Include all the CSS and JavaScript from the original file -->
    <!-- This is a simplified version - you would copy the full content -->
</head>
<body>
    <!-- Family-specific content would be generated here -->
    <script>
        // Initialize with the new family's data
        let familyData = {
            family: {
                id: "${family.id}",
                name: "${family.name}",
                address: "${family.address}",
                phone: "${family.phone}",
                email: "${family.email}",
                createdAt: "${family.createdAt}"
            },
            members: [
                {
                    id: "${generateId()}",
                    firstName: "Super",
                    lastName: "Admin",
                    email: "${family.adminEmail}",
                    phone: "${family.phone}",
                    role: "super_admin",
                    password: "${family.adminPassword}",
                    balance: 0,
                    isActive: true,
                    createdAt: "${family.createdAt}"
                }
            ],
            pricePlans: [],
            subscriptions: [],
            statements: [],
            activities: []
        };
    </script>
</body>
</html>`;
          }
          
          function openFamilyDashboard(fileName) {
              // Open the family's HTML file in a new tab
              window.open(fileName, '_blank');
          }
          
          function deleteFamily(familyId) {
              const family = allFamilies.find(f => f.id === familyId);
              if (!family) return;
              
              currentDeletingId = familyId;
              currentDeletingType = 'family';
              
              document.getElementById('deleteConfirmMessage').innerHTML = 
                  `Are you sure you want to delete <strong>${family.name}</strong>?<br><br>
                   This will remove the family from the system.`;
              
              openModal('deleteConfirmModal');
          }

          function displayFamilyInfo() {
              const family = familyData.family;
              document.getElementById('familyInfo').innerHTML = `
                  <table class="data-table">
                      <thead>
                          <tr>
                              <th>Property</th>
                              <th>Value</th>
                          </tr>
                      </thead>
                      <tbody>
                          <tr>
                              <td><strong>Family Name</strong></td>
                              <td>${family.name}</td>
                          </tr>
                          <tr>
                              <td><strong>Address</strong></td>
                              <td>${family.address}</td>
                          </tr>
                          <tr>
                              <td><strong>Phone</strong></td>
                              <td>${family.phone}</td>
                          </tr>
                          <tr>
                              <td><strong>Email</strong></td>
                              <td>${family.email}</td>
                          </tr>
                          <tr>
                              <td><strong>Created</strong></td>
                              <td>${new Date(family.createdAt).toLocaleDateString()}</td>
                          </tr>
                      </tbody>
                  </table>
              `;
              
              // Update family actions
              const familyActionsDiv = document.getElementById('familyActions');
              if (familyActionsDiv) {
                  if (canEditData()) {
                      familyActionsDiv.innerHTML = '<button class="btn" onclick="editFamily()">Edit Family</button>';
                  } else {
                      familyActionsDiv.innerHTML = '';
                  }
              }
          }

          function displayMembers() {
             const filteredMembers = getFilteredMembers();
             if (filteredMembers.length === 0) {
                 document.getElementById('membersList').innerHTML = '<div class="empty-state">No members found</div>';
                 return;
             }
            
            const membersHtml = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Role</th>
                            <th>Pricing Plan</th>
                            <th>Balance</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredMembers.map(member => `
                            <tr onclick="editMember('${member.id}')" style="cursor: pointer;">
                                <td><strong>${member.firstName} ${member.lastName}</strong></td>
                                <td>${member.email}</td>
                                <td>${member.phone}</td>
                                <td><span class="status-badge status-active">${member.role}</span></td>
                                <td>${member.pricingPlanId ? getPricingPlanName(member.pricingPlanId) : '-'}</td>
                                <td>$${member.balance}</td>
                                <td><span class="status-badge ${member.isActive ? 'status-active' : 'status-inactive'}">${member.isActive ? 'Active' : 'Inactive'}</span></td>
                                <td>
                                    <div class="table-actions">
                                        ${canEditData() ? `<button class="btn btn-warning" onclick="editMember('${member.id}'); event.stopPropagation();">Edit</button>` : ''}
                                        ${canDeleteData() ? `<button class="btn btn-danger" onclick="deleteMember('${member.id}'); event.stopPropagation();">Delete</button>` : ''}
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
             document.getElementById('membersList').innerHTML = membersHtml;
             
             // Update members actions
             const membersActionsDiv = document.getElementById('membersActions');
             if (membersActionsDiv) {
                 if (canEditData()) {
                     membersActionsDiv.innerHTML = '<button class="btn" onclick="showAddMemberForm()">Add Member</button>';
                 } else {
                     membersActionsDiv.innerHTML = '';
                 }
             }
         }

                 function displaySubscriptions() {
             const filteredSubscriptions = getFilteredSubscriptions();
             if (filteredSubscriptions.length === 0) {
                 document.getElementById('subscriptionsList').innerHTML = '<div class="empty-state">No subscriptions found</div>';
                 return;
             }
            
            const subscriptionsHtml = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Plan</th>
                            <th>Member</th>
                            <th>Monthly Amount</th>
                            <th>Status</th>
                            <th>Progress</th>
                            <th>Start Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredSubscriptions.map(sub => `
                            <tr onclick="editSubscription('${sub.id}')" style="cursor: pointer;">
                                <td><strong>${sub.pricePlanTitle}</strong></td>
                                <td>${getMemberName(sub.memberId)}</td>
                                <td>$${sub.monthlyAmount}</td>
                                <td><span class="status-badge status-${sub.status}">${sub.status}</span></td>
                                <td>${sub.currentMonth}/${sub.totalMonths}</td>
                                <td>${new Date(sub.startDate).toLocaleDateString()}</td>
                                <td>
                                    <div class="table-actions">
                                        ${canEditData() ? `<button class="btn btn-warning" onclick="editSubscription('${sub.id}'); event.stopPropagation();">Edit</button>` : ''}
                                        ${canDeleteData() ? `<button class="btn btn-danger" onclick="deleteSubscription('${sub.id}'); event.stopPropagation();">Delete</button>` : ''}
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
             document.getElementById('subscriptionsList').innerHTML = subscriptionsHtml;
             
             // Update subscriptions actions
             const subscriptionsActionsDiv = document.getElementById('subscriptionsActions');
             if (subscriptionsActionsDiv) {
                 if (canEditData()) {
                     subscriptionsActionsDiv.innerHTML = '<button class="btn" onclick="showAddSubscriptionForm()">Add Subscription</button>';
                 } else {
                     subscriptionsActionsDiv.innerHTML = '';
                 }
             }
         }

                           function displayStatements() {
              const filteredStatements = getFilteredStatements();
              if (filteredStatements.length === 0) {
                  document.getElementById('statementsList').innerHTML = '<div class="empty-state">No statements found</div>';
                  return;
              }
             
             const statementsHtml = `
                 <table class="data-table">
                     <thead>
                         <tr>
                             <th>Statement #</th>
                             <th>Member</th>
                             <th>Amount</th>
                             <th>Status</th>
                             <th>Billing Date</th>
                             <th>Due Date</th>
                             <th>Actions</th>
                         </tr>
                     </thead>
                                           <tbody>
                                                    ${filteredStatements.map(stmt => `
                               <tr onclick="editStatement('${stmt.id}')" style="cursor: pointer;">
                                  <td><strong>#${stmt.statementNumber}</strong></td>
                                  <td>${getMemberName(stmt.memberId)}</td>
                                  <td>$${stmt.amount}</td>
                                  <td><span class="status-badge status-${stmt.status}">${stmt.status.toUpperCase()}</span></td>
                                  <td>${new Date(stmt.billingDate).toLocaleDateString()}</td>
                                  <td>${new Date(stmt.dueDate).toLocaleDateString()}</td>
                                                                     <td>
                                       <div class="table-actions">
                                           ${canEditData() ? `<button class="btn btn-warning" onclick="editStatement('${stmt.id}'); event.stopPropagation();">Edit</button>` : ''}
                                           <button class="btn btn-success" onclick="downloadStatement('${stmt.id}'); event.stopPropagation();">üìÑ Download</button>
                                           ${stmt.status === 'pending' ? `<button class="btn btn-success" onclick="payStatement('${stmt.id}'); event.stopPropagation();">Pay Now</button>` : ''}
                                           ${canDeleteData() ? `<button class="btn btn-danger" onclick="deleteStatement('${stmt.id}'); event.stopPropagation();">Delete</button>` : ''}
                                       </div>
                                   </td>
                              </tr>
                          `).join('')}
                     </tbody>
                 </table>
                           `;
              document.getElementById('statementsList').innerHTML = statementsHtml;
              
              // Update statements actions
              const statementsActionsDiv = document.getElementById('statementsActions');
              if (statementsActionsDiv) {
                  if (canEditData()) {
                      statementsActionsDiv.innerHTML = '<button class="btn" onclick="generateNextMonth()">Generate Next Month</button>';
                  } else {
                      statementsActionsDiv.innerHTML = '';
                  }
              }
          }

         function displayPricingPlans() {
             if (familyData.pricePlans.length === 0) {
                 document.getElementById('pricingList').innerHTML = '<div class="empty-state">No pricing plans found</div>';
                 return;
             }
             
             const pricingHtml = `
                 <table class="data-table">
                     <thead>
                         <tr>
                             <th>Plan Title</th>
                             <th>Description</th>
                             <th>Yearly Price</th>
                             <th>Monthly Price</th>
                             <th>Features</th>
                             <th>Status</th>
                             <th>Actions</th>
                         </tr>
                     </thead>
                     <tbody>
                         ${familyData.pricePlans.map(plan => `
                             <tr onclick="editPricing('${plan.id}')" style="cursor: pointer;">
                                 <td><strong>${plan.title}</strong></td>
                                 <td>${plan.description}</td>
                                 <td>$${plan.yearlyPrice}</td>
                                 <td>$${plan.monthlyPrice}</td>
                                 <td>${plan.features.join(', ')}</td>
                                 <td><span class="status-badge ${plan.isActive ? 'status-active' : 'status-inactive'}">${plan.isActive ? 'Active' : 'Inactive'}</span></td>
                                                                   <td>
                                      <div class="table-actions">
                                          ${canEditData() ? `<button class="btn btn-warning" onclick="editPricing('${plan.id}'); event.stopPropagation();">Edit</button>` : ''}
                                          ${canDeleteData() ? `<button class="btn btn-danger" onclick="deletePricing('${plan.id}'); event.stopPropagation();">Delete</button>` : ''}
                                      </div>
                                  </td>
                             </tr>
                         `).join('')}
                     </tbody>
                 </table>
                           `;
              document.getElementById('pricingList').innerHTML = pricingHtml;
              
              // Update pricing actions
              const pricingActionsDiv = document.getElementById('pricingActions');
              if (pricingActionsDiv) {
                  if (canEditData()) {
                      pricingActionsDiv.innerHTML = '<button class="btn" onclick="showAddPricingForm()">Add Pricing Plan</button>';
                  } else {
                      pricingActionsDiv.innerHTML = '';
                  }
              }
          }

                 function getMemberName(memberId) {
             const member = familyData.members.find(m => m.id === memberId);
             return member ? `${member.firstName} ${member.lastName}` : 'Unknown';
         }
         
         function getPricingPlanName(planId) {
             const plan = familyData.pricePlans.find(p => p.id === planId);
             return plan ? plan.title : 'Unknown Plan';
         }

                 function showAddMemberForm() {
             // Clear form fields
             document.getElementById('addMemberFirstName').value = '';
             document.getElementById('addMemberLastName').value = '';
             document.getElementById('addMemberEmail').value = '';
             document.getElementById('addMemberPhone').value = '';
             document.getElementById('addMemberRole').value = 'member';
             document.getElementById('addMemberPricingPlan').value = '';
             
             // Populate pricing plan dropdown
             const pricingSelect = document.getElementById('addMemberPricingPlan');
             pricingSelect.innerHTML = '<option value="">Select a pricing plan (optional)</option>' + 
                 familyData.pricePlans.map(p => 
                     `<option value="${p.id}">${p.title} - $${p.yearlyPrice}/year</option>`
                 ).join('');
             
             openModal('addMemberModal');
         }

                 function showAddSubscriptionForm() {
             // Populate member dropdown
             const memberSelect = document.getElementById('addSubscriptionMember');
             memberSelect.innerHTML = familyData.members.map(m => 
                 `<option value="${m.id}">${m.firstName} ${m.lastName}</option>`
             ).join('');
             
             // Populate plan dropdown
             const planSelect = document.getElementById('addSubscriptionPlan');
             planSelect.innerHTML = familyData.pricePlans.map(p => 
                 `<option value="${p.id}">${p.title} - $${p.monthlyPrice}/month</option>`
             ).join('');
             
             // Set default date to today
             document.getElementById('addSubscriptionStartDate').value = new Date().toISOString().split('T')[0];
             
             openModal('addSubscriptionModal');
         }

         function showAddPricingForm() {
             // Clear form fields
             document.getElementById('addPricingTitle').value = '';
             document.getElementById('addPricingDescription').value = '';
             document.getElementById('addPricingYearlyPrice').value = '';
             document.getElementById('addPricingMonthlyPrice').value = '';
             document.getElementById('addPricingFeatures').value = '';
             document.getElementById('addPricingStatus').value = 'active';
             
             openModal('addPricingModal');
         }

                                   function saveNewMember() {
             const firstName = document.getElementById('addMemberFirstName').value.trim();
             const lastName = document.getElementById('addMemberLastName').value.trim();
             const email = document.getElementById('addMemberEmail').value.trim();
             const phone = document.getElementById('addMemberPhone').value.trim();
             const role = document.getElementById('addMemberRole').value;
             const pricingPlanId = document.getElementById('addMemberPricingPlan').value || null;
             
             // Validate required fields
             if (!firstName || !lastName || !email || !phone) {
                 alert('Please fill in all required fields (First Name, Last Name, Email, Phone)');
                 return;
             }
             
             // Validate email format
             const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
             if (!emailRegex.test(email)) {
                 alert('Please enter a valid email address');
                 return;
             }
             
             // Validate phone format (basic validation)
             const phoneRegex = /^[\+]?[1-9][\d]{0,15}$/;
             const cleanPhone = phone.replace(/[\s\-\(\)]/g, '');
             if (!phoneRegex.test(cleanPhone)) {
                 alert('Please enter a valid phone number');
                 return;
             }
             
             const newMember = {
                 id: generateId(),
                 firstName: firstName,
                 lastName: lastName,
                 email: email,
                 phone: formatPhoneNumber(cleanPhone),
                 role: role,
                 pricingPlanId: pricingPlanId,
                 balance: 0,
                 isActive: true,
                 createdAt: new Date().toISOString()
             };
             
             familyData.members.push(newMember);
             
             // Auto-create subscription if pricing plan is assigned
             if (pricingPlanId) {
                 const plan = familyData.pricePlans.find(p => p.id === pricingPlanId);
                 if (plan) {
                     const newSubscription = {
                         id: generateId(),
                         memberId: newMember.id,
                         pricePlanId: pricingPlanId,
                         pricePlanTitle: plan.title,
                         yearlyPrice: plan.yearlyPrice,
                         monthlyAmount: plan.monthlyPrice,
                         startDate: new Date().toISOString().split('T')[0],
                         endDate: null,
                         status: 'active',
                         currentMonth: 0,
                         totalMonths: 12,
                         createdAt: new Date().toISOString()
                     };
                     
                     familyData.subscriptions.push(newSubscription);
                     
                     // Generate first statement
                     const firstStatement = generateStatement(newSubscription, 1);
                     familyData.statements.push(firstStatement);
                     newSubscription.currentMonth = 1;
                 }
             }
             
                           closeModal('addMemberModal');
              refreshDisplay();
              autoSave(); // Auto-save data
              
              // Success animation
              document.querySelector('.content-header').classList.add('success-animation');
              setTimeout(() => {
                  document.querySelector('.content-header').classList.remove('success-animation');
              }, 500);
         }

        function saveNewSubscription() {
            const memberId = document.getElementById('addSubscriptionMember').value;
            const planId = document.getElementById('addSubscriptionPlan').value;
            const startDate = document.getElementById('addSubscriptionStartDate').value;
            
            // Validate required fields
            if (!memberId || !planId || !startDate) {
                alert('Please fill in all required fields');
                return;
            }
            
            const plan = familyData.pricePlans.find(p => p.id === planId);
            
            const newSubscription = {
                id: generateId(),
                memberId: memberId,
                pricePlanId: planId,
                pricePlanTitle: plan.title,
                yearlyPrice: plan.yearlyPrice,
                monthlyAmount: plan.monthlyPrice,
                startDate: startDate,
                endDate: null,
                status: 'active',
                currentMonth: 1,
                totalMonths: 12,
                createdAt: new Date().toISOString()
            };
            
                         familyData.subscriptions.push(newSubscription);
             
             // Generate first statement
             const firstStatement = generateStatement(newSubscription, 1);
             familyData.statements.push(firstStatement);
             
                           closeModal('addSubscriptionModal');
              refreshDisplay();
              autoSave(); // Auto-save data
              
              // Success animation
              document.querySelector('.content-header').classList.add('success-animation');
              setTimeout(() => {
                  document.querySelector('.content-header').classList.remove('success-animation');
              }, 500);
         }

         function saveNewPricing() {
             const newPlan = {
                 id: generateId(),
                 title: document.getElementById('addPricingTitle').value.trim(),
                 description: document.getElementById('addPricingDescription').value.trim(),
                 yearlyPrice: parseCurrencyValue(document.getElementById('addPricingYearlyPrice').value) || 0,
                 monthlyPrice: parseCurrencyValue(document.getElementById('addPricingMonthlyPrice').value) || 0,
                 features: document.getElementById('addPricingFeatures').value.split(',').map(f => f.trim()).filter(f => f),
                 isActive: document.getElementById('addPricingStatus').value === 'active'
             };
             
             // Validate required fields
             if (!newPlan.title || !newPlan.description || newPlan.yearlyPrice <= 0 || newPlan.monthlyPrice <= 0) {
                 alert('Please fill in all required fields (Title, Description, Yearly Price, Monthly Price)');
                 return;
             }
             
                           familyData.pricePlans.push(newPlan);
              closeModal('addPricingModal');
              refreshDisplay();
              autoSave(); // Auto-save data
              
              // Success animation
              document.querySelector('.content-header').classList.add('success-animation');
              setTimeout(() => {
                  document.querySelector('.content-header').classList.remove('success-animation');
              }, 500);
         }

                 function generateStatement(subscription, monthNumber) {
             const startDate = new Date(subscription.startDate);
             const billingDate = new Date(startDate.getFullYear(), startDate.getMonth() + monthNumber - 1, 1);
             const dueDate = new Date(billingDate);
             dueDate.setDate(dueDate.getDate() + 30);
             
             // Auto-increment statement number
             const nextStatementNumber = familyData.statements.length + 1;
             
             return {
                 id: generateId(),
                 memberId: subscription.memberId,
                 subscriptionId: subscription.id,
                 amount: subscription.monthlyAmount,
                 billingDate: billingDate.toISOString(),
                 dueDate: dueDate.toISOString(),
                 status: 'pending',
                 description: `Monthly payment for ${subscription.pricePlanTitle}`,
                 statementNumber: nextStatementNumber,
                 createdAt: new Date().toISOString()
             };
         }

        function generateNextMonth() {
            // Generate statements for existing subscriptions
            familyData.subscriptions.forEach(subscription => {
                if (subscription.status === 'active' && subscription.currentMonth < subscription.totalMonths) {
                    const nextStatement = generateStatement(subscription, subscription.currentMonth + 1);
                    familyData.statements.push(nextStatement);
                    subscription.currentMonth++;
                }
            });
            
            // Generate statements for members with pricing plans but no subscriptions
            familyData.members.forEach(member => {
                if (member.pricingPlanId && member.isActive) {
                    // Check if member already has a subscription
                    const existingSubscription = familyData.subscriptions.find(s => s.memberId === member.id);
                    
                    if (!existingSubscription) {
                        // Create a subscription for this member
                        const plan = familyData.pricePlans.find(p => p.id === member.pricingPlanId);
                        if (plan) {
                            const newSubscription = {
                                id: generateId(),
                                memberId: member.id,
                                pricePlanId: member.pricingPlanId,
                                pricePlanTitle: plan.title,
                                yearlyPrice: plan.yearlyPrice,
                                monthlyAmount: plan.monthlyPrice,
                                startDate: new Date().toISOString().split('T')[0],
                                endDate: null,
                                status: 'active',
                                currentMonth: 1,
                                totalMonths: 12,
                                createdAt: new Date().toISOString()
                            };
                            
                            familyData.subscriptions.push(newSubscription);
                            
                            // Generate first statement
                            const firstStatement = generateStatement(newSubscription, 1);
                            familyData.statements.push(firstStatement);
                        }
                    }
                }
            });
            
            refreshDisplay();
        }

                 function payStatement(statementId) {
             const statement = familyData.statements.find(s => s.id === statementId);
             if (statement) {
                 statement.status = 'paid';
                 statement.paidDate = new Date().toISOString();
                 
                 // Update member balance
                 const member = familyData.members.find(m => m.id === statement.memberId);
                 if (member) {
                     member.balance += statement.amount;
                 }
                 
                 refreshDisplay();
             }
         }

         function downloadStatement(statementId) {
             const statement = familyData.statements.find(s => s.id === statementId);
             if (!statement) return;
             
             const member = familyData.members.find(m => m.id === statement.memberId);
             const subscription = familyData.subscriptions.find(s => s.id === statement.subscriptionId);
             
             // Create a beautiful PDF-like statement
             const statementHTML = `
                 <!DOCTYPE html>
                 <html>
                 <head>
                     <meta charset="UTF-8">
                     <title>Statement #${statement.statementNumber}</title>
                     <style>
                         body { 
                             font-family: 'Arial', sans-serif; 
                             margin: 0; 
                             padding: 40px; 
                             background: #f8f9fa;
                             color: #333;
                         }
                         .statement-container {
                             max-width: 800px;
                             margin: 0 auto;
                             background: white;
                             border-radius: 12px;
                             box-shadow: 0 10px 30px rgba(0,0,0,0.1);
                             overflow: hidden;
                         }
                         .header {
                             background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                             color: white;
                             padding: 30px;
                             text-align: center;
                         }
                         .header h1 {
                             margin: 0;
                             font-size: 2.5rem;
                             font-weight: 700;
                         }
                         .header p {
                             margin: 10px 0 0 0;
                             font-size: 1.1rem;
                             opacity: 0.9;
                         }
                         .content {
                             padding: 40px;
                         }
                         .info-grid {
                             display: grid;
                             grid-template-columns: 1fr 1fr;
                             gap: 30px;
                             margin-bottom: 40px;
                         }
                         .info-section h3 {
                             color: #667eea;
                             margin-bottom: 15px;
                             font-size: 1.2rem;
                         }
                         .info-item {
                             margin-bottom: 10px;
                             display: flex;
                             justify-content: space-between;
                         }
                         .info-label {
                             font-weight: 600;
                             color: #666;
                         }
                         .info-value {
                             font-weight: 500;
                         }
                         .amount-section {
                             background: #f8f9fa;
                             padding: 30px;
                             border-radius: 8px;
                             text-align: center;
                             margin: 30px 0;
                         }
                         .amount-label {
                             font-size: 1.1rem;
                             color: #666;
                             margin-bottom: 10px;
                         }
                         .amount-value {
                             font-size: 3rem;
                             font-weight: 700;
                             color: #667eea;
                         }
                         .status-badge {
                             display: inline-block;
                             padding: 8px 16px;
                             border-radius: 20px;
                             font-weight: 600;
                             text-transform: uppercase;
                             font-size: 0.9rem;
                         }
                         .status-${statement.status} {
                             background: ${statement.status === 'paid' ? '#d4edda' : statement.status === 'pending' ? '#fff3cd' : '#f8d7da'};
                             color: ${statement.status === 'paid' ? '#155724' : statement.status === 'pending' ? '#856404' : '#721c24'};
                         }
                         .footer {
                             background: #f8f9fa;
                             padding: 20px 40px;
                             text-align: center;
                             color: #666;
                             font-size: 0.9rem;
                         }
                         @media print {
                             body { background: white; }
                             .statement-container { box-shadow: none; }
                         }
                     </style>
                 </head>
                 <body>
                     <div class="statement-container">
                         <div class="header">
                             <h1>üìÑ STATEMENT</h1>
                             <p>Goldberger Family Services</p>
                         </div>
                         
                         <div class="content">
                             <div class="info-grid">
                                 <div class="info-section">
                                     <h3>üìã Statement Details</h3>
                                     <div class="info-item">
                                         <span class="info-label">Statement #:</span>
                                         <span class="info-value">${statement.statementNumber}</span>
                                     </div>
                                     <div class="info-item">
                                         <span class="info-label">Billing Date:</span>
                                         <span class="info-value">${new Date(statement.billingDate).toLocaleDateString()}</span>
                                     </div>
                                     <div class="info-item">
                                         <span class="info-label">Due Date:</span>
                                         <span class="info-value">${new Date(statement.dueDate).toLocaleDateString()}</span>
                                     </div>
                                     <div class="info-item">
                                         <span class="info-label">Status:</span>
                                         <span class="info-value">
                                             <span class="status-badge status-${statement.status}">${statement.status.toUpperCase()}</span>
                                         </span>
                                     </div>
                                 </div>
                                 
                                 <div class="info-section">
                                     <h3>üë§ Member Information</h3>
                                     <div class="info-item">
                                         <span class="info-label">Name:</span>
                                         <span class="info-value">${member ? member.firstName + ' ' + member.lastName : 'Unknown'}</span>
                                     </div>
                                     <div class="info-item">
                                         <span class="info-label">Email:</span>
                                         <span class="info-value">${member ? member.email : 'N/A'}</span>
                                     </div>
                                     <div class="info-item">
                                         <span class="info-label">Phone:</span>
                                         <span class="info-value">${member ? member.phone : 'N/A'}</span>
                                     </div>
                                     <div class="info-item">
                                         <span class="info-label">Plan:</span>
                                         <span class="info-value">${subscription ? subscription.pricePlanTitle : 'N/A'}</span>
                                     </div>
                                 </div>
                             </div>
                             
                             <div class="amount-section">
                                 <div class="amount-label">Amount Due</div>
                                 <div class="amount-value">$${statement.amount.toFixed(2)}</div>
                             </div>
                             
                             <div class="info-section">
                                 <h3>üìù Description</h3>
                                 <p>${statement.description}</p>
                             </div>
                         </div>
                         
                         <div class="footer">
                             <p>Generated on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}</p>
                             <p>Goldberger Family Services - Professional Family Management</p>
                         </div>
                     </div>
                 </body>
                 </html>
             `;
             
             // Create a new window with the statement
             const newWindow = window.open('', '_blank');
             newWindow.document.write(statementHTML);
             newWindow.document.close();
             
             // Wait for content to load, then print
             newWindow.onload = function() {
                 newWindow.print();
             };
         }

        function generateId() {
            return Math.random().toString(36).substr(2, 9);
        }

                           function refreshDisplay() {
              displayFamilyInfo();
              displayMembers();
              displaySubscriptions();
              displayPricingPlans();
              displayStatements();
              displayFamilies();
              updateStats();
              updateQuickActions();
          }

        // ===== SIDEBAR NAVIGATION =====
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Show selected section
            document.getElementById(sectionName + '-section').style.display = 'block';
            
            // Update active nav link
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Close mobile menu if open
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('mobile-open');
            }
            
            // Refresh display for the section
            refreshDisplay();
        }

        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('mobile-open');
        }

        // Close mobile menu when clicking outside
        document.addEventListener('click', function(e) {
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                const mobileToggle = document.querySelector('.mobile-menu-toggle');
                
                if (!sidebar.contains(e.target) && !mobileToggle.contains(e.target)) {
                    sidebar.classList.remove('mobile-open');
                }
            }
        });

                           // ===== INSTANT INITIALIZATION =====
          // Load everything instantly when page loads
          document.addEventListener('DOMContentLoaded', function() {
              // Load data from localStorage first
              const dataLoaded = loadFromLocalStorage();
              
              // Check if user is already logged in
              const savedUser = localStorage.getItem('currentUser');
              if (savedUser) {
                  try {
                      currentUser = JSON.parse(savedUser);
                      // Verify user still exists in data
                      const userExists = familyData.members.find(m => m.id === currentUser.id);
                      if (userExists && userExists.isActive) {
                          // Auto-login
                          document.getElementById('loginScreen').style.display = 'none';
                          document.getElementById('mainApp').style.display = 'flex';
                          updateUserInfo();
                          refreshDisplay();
                          showSection('overview');
                          console.log(`üë§ Auto-logged in as: ${currentUser.firstName} ${currentUser.lastName} (${currentUser.role})`);
                      } else {
                          // User no longer exists or is inactive
                          localStorage.removeItem('currentUser');
                          currentUser = null;
                      }
                  } catch (error) {
                      console.error('Error parsing saved user:', error);
                      localStorage.removeItem('currentUser');
                      currentUser = null;
                  }
              }
              
              if (dataLoaded) {
                  console.log('üöÄ Lightning Fast Dashboard Loaded - Data restored from localStorage!');
              } else {
                  console.log('üöÄ Lightning Fast Dashboard Loaded - Using default data!');
              }
          });

                 // ===== EXPORT FUNCTIONALITY =====
         function exportData() {
             const dataStr = JSON.stringify(familyData, null, 2);
             const dataBlob = new Blob([dataStr], {type: 'application/json'});
             const url = URL.createObjectURL(dataBlob);
             const link = document.createElement('a');
             link.href = url;
             link.download = 'family-data.json';
             link.click();
         }

                 // ===== MODAL FUNCTIONS =====
         let currentEditingId = null;
         let currentDeletingId = null;
         let currentDeletingType = null;

        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('active');
            setTimeout(() => {
                modal.querySelector('.modal').classList.add('active');
            }, 10);
        }

                 function closeModal(modalId) {
             const modal = document.getElementById(modalId);
             modal.querySelector('.modal').classList.remove('active');
             setTimeout(() => {
                 modal.classList.remove('active');
             }, 300);
             currentEditingId = null;
             currentDeletingId = null;
             currentDeletingType = null;
         }

        // ===== EDIT FUNCTIONS WITH POPUPS =====
        function editFamily() {
            const family = familyData.family;
            
            // Populate form with current data
            document.getElementById('editFamilyName').value = family.name;
            document.getElementById('editFamilyAddress').value = family.address;
            document.getElementById('editFamilyPhone').value = family.phone;
            document.getElementById('editFamilyEmail').value = family.email;
            
            openModal('editFamilyModal');
        }

        function editMember(memberId) {
            const member = familyData.members.find(m => m.id === memberId);
            if (!member) return;
            
            currentEditingId = memberId;
            
            // Populate form with current data
            document.getElementById('editMemberFirstName').value = member.firstName;
            document.getElementById('editMemberLastName').value = member.lastName;
                         document.getElementById('editMemberEmail').value = member.email;
             document.getElementById('editMemberPhone').value = member.phone;
             document.getElementById('editMemberRole').value = member.role;
             document.getElementById('editMemberPricingPlan').value = member.pricingPlanId || '';
             
             // Populate pricing plan dropdown
             const editPricingSelect = document.getElementById('editMemberPricingPlan');
             editPricingSelect.innerHTML = '<option value="">Select a pricing plan (optional)</option>' + 
                 familyData.pricePlans.map(p => 
                     `<option value="${p.id}">${p.title} - $${p.yearlyPrice}/year</option>`
                 ).join('');
            
            openModal('editMemberModal');
        }

                 function editSubscription(subscriptionId) {
             const subscription = familyData.subscriptions.find(s => s.id === subscriptionId);
             if (!subscription) return;
             
             currentEditingId = subscriptionId;
             
             // Populate form with current data
             document.getElementById('editSubscriptionStatus').value = subscription.status;
             document.getElementById('editSubscriptionAmount').value = `$${subscription.monthlyAmount.toFixed(2)}`;
             
             openModal('editSubscriptionModal');
         }

         function editPricing(planId) {
             const plan = familyData.pricePlans.find(p => p.id === planId);
             if (!plan) return;
             
             currentEditingId = planId;
             
             // Populate form with current data
             document.getElementById('editPricingTitle').value = plan.title;
             document.getElementById('editPricingDescription').value = plan.description;
             document.getElementById('editPricingYearlyPrice').value = `$${plan.yearlyPrice.toFixed(2)}`;
             document.getElementById('editPricingMonthlyPrice').value = `$${plan.monthlyPrice.toFixed(2)}`;
             document.getElementById('editPricingFeatures').value = plan.features.join(', ');
             document.getElementById('editPricingStatus').value = plan.isActive ? 'active' : 'inactive';
             
             openModal('editPricingModal');
         }

         function editStatement(statementId) {
             const statement = familyData.statements.find(s => s.id === statementId);
             if (!statement) return;
             
             currentEditingId = statementId;
             
             // Populate form with current data
             document.getElementById('editStatementStatus').value = statement.status;
             document.getElementById('editStatementAmount').value = `$${statement.amount.toFixed(2)}`;
             document.getElementById('editStatementBillingDate').value = statement.billingDate.split('T')[0];
             document.getElementById('editStatementDueDate').value = statement.dueDate.split('T')[0];
             
             openModal('editStatementModal');
         }

        // ===== SAVE FUNCTIONS =====
        function saveFamilyChanges() {
            const family = familyData.family;
            
            family.name = document.getElementById('editFamilyName').value.trim();
            family.address = document.getElementById('editFamilyAddress').value.trim();
            family.phone = document.getElementById('editFamilyPhone').value.trim();
            family.email = document.getElementById('editFamilyEmail').value.trim();
            
                         closeModal('editFamilyModal');
             refreshDisplay();
             autoSave(); // Auto-save data
             
             // Success animation
             document.querySelector('.content-header').classList.add('success-animation');
             setTimeout(() => {
                 document.querySelector('.content-header').classList.remove('success-animation');
             }, 500);
        }

                          function saveMemberChanges() {
             if (!currentEditingId) return;
             
             const member = familyData.members.find(m => m.id === currentEditingId);
             if (!member) return;
             
             const firstName = document.getElementById('editMemberFirstName').value.trim();
             const lastName = document.getElementById('editMemberLastName').value.trim();
             const email = document.getElementById('editMemberEmail').value.trim();
             const phone = document.getElementById('editMemberPhone').value.trim();
             const role = document.getElementById('editMemberRole').value;
             const pricingPlanId = document.getElementById('editMemberPricingPlan').value || null;
             
             // Validate required fields
             if (!firstName || !lastName || !email || !phone) {
                 alert('Please fill in all required fields (First Name, Last Name, Email, Phone)');
                 return;
             }
             
             // Validate email format
             const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
             if (!emailRegex.test(email)) {
                 alert('Please enter a valid email address');
                 return;
             }
             
             // Validate phone format (basic validation)
             const phoneRegex = /^[\+]?[1-9][\d]{0,15}$/;
             const cleanPhone = phone.replace(/[\s\-\(\)]/g, '');
             if (!phoneRegex.test(cleanPhone)) {
                 alert('Please enter a valid phone number');
                 return;
             }
             
             // Check if pricing plan is being assigned for the first time
             const hadPricingPlan = member.pricingPlanId;
             const isNewPricingPlan = pricingPlanId && !hadPricingPlan;
             
             member.firstName = firstName;
             member.lastName = lastName;
             member.email = email;
             member.phone = formatPhoneNumber(cleanPhone);
             member.role = role;
             member.pricingPlanId = pricingPlanId;
             
             // Auto-create subscription if pricing plan is newly assigned
             if (isNewPricingPlan) {
                 const plan = familyData.pricePlans.find(p => p.id === pricingPlanId);
                 if (plan) {
                     const newSubscription = {
                         id: generateId(),
                         memberId: member.id,
                         pricePlanId: pricingPlanId,
                         pricePlanTitle: plan.title,
                         yearlyPrice: plan.yearlyPrice,
                         monthlyAmount: plan.monthlyPrice,
                         startDate: new Date().toISOString().split('T')[0],
                         endDate: null,
                         status: 'active',
                         currentMonth: 0,
                         totalMonths: 12,
                         createdAt: new Date().toISOString()
                     };
                     
                     familyData.subscriptions.push(newSubscription);
                     
                     // Generate first statement
                     const firstStatement = generateStatement(newSubscription, 1);
                     familyData.statements.push(firstStatement);
                     newSubscription.currentMonth = 1;
                 }
             }
             
                           closeModal('editMemberModal');
              refreshDisplay();
              autoSave(); // Auto-save data
              
              // Success animation
              document.querySelector('.content-header').classList.add('success-animation');
              setTimeout(() => {
                  document.querySelector('.content-header').classList.remove('success-animation');
              }, 500);
         }

                 function saveSubscriptionChanges() {
             if (!currentEditingId) return;
             
             const subscription = familyData.subscriptions.find(s => s.id === currentEditingId);
             if (!subscription) return;
             
             subscription.status = document.getElementById('editSubscriptionStatus').value;
             subscription.monthlyAmount = parseCurrencyValue(document.getElementById('editSubscriptionAmount').value) || subscription.monthlyAmount;
             
                           closeModal('editSubscriptionModal');
              refreshDisplay();
              autoSave(); // Auto-save data
              
              // Success animation
              document.querySelector('.section').classList.add('success-animation');
              setTimeout(() => {
                  document.querySelector('.section').classList.remove('success-animation');
              }, 500);
         }

         function savePricingChanges() {
             if (!currentEditingId) return;
             
             const plan = familyData.pricePlans.find(p => p.id === currentEditingId);
             if (!plan) return;
             
             plan.title = document.getElementById('editPricingTitle').value.trim();
             plan.description = document.getElementById('editPricingDescription').value.trim();
             plan.yearlyPrice = parseCurrencyValue(document.getElementById('editPricingYearlyPrice').value) || plan.yearlyPrice;
             plan.monthlyPrice = parseCurrencyValue(document.getElementById('editPricingMonthlyPrice').value) || plan.monthlyPrice;
             plan.features = document.getElementById('editPricingFeatures').value.split(',').map(f => f.trim()).filter(f => f);
             plan.isActive = document.getElementById('editPricingStatus').value === 'active';
             
                           closeModal('editPricingModal');
              refreshDisplay();
              autoSave(); // Auto-save data
              
              // Success animation
              document.querySelector('.content-header').classList.add('success-animation');
              setTimeout(() => {
                  document.querySelector('.content-header').classList.remove('success-animation');
              }, 500);
         }

         function saveStatementChanges() {
             if (!currentEditingId) return;
             
             const statement = familyData.statements.find(s => s.id === currentEditingId);
             if (!statement) return;
             
             statement.status = document.getElementById('editStatementStatus').value;
             statement.amount = parseCurrencyValue(document.getElementById('editStatementAmount').value) || statement.amount;
             statement.billingDate = document.getElementById('editStatementBillingDate').value + 'T00:00:00.000Z';
             statement.dueDate = document.getElementById('editStatementDueDate').value + 'T00:00:00.000Z';
             
             // If status changed to paid, update member balance
             if (statement.status === 'paid' && !statement.paidDate) {
                 statement.paidDate = new Date().toISOString();
                 const member = familyData.members.find(m => m.id === statement.memberId);
                 if (member) {
                     member.balance += statement.amount;
                 }
             }
             
                           closeModal('editStatementModal');
              refreshDisplay();
              autoSave(); // Auto-save data
              
              // Success animation
              document.querySelector('.content-header').classList.add('success-animation');
              setTimeout(() => {
                  document.querySelector('.content-header').classList.remove('success-animation');
              }, 500);
         }

        // Close modal when clicking outside
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', function(e) {
                    if (e.target === overlay) {
                        const modalId = overlay.id;
                        closeModal(modalId);
                    }
                });
            });
        });

                 // ===== DELETE FUNCTIONS =====
         function deleteMember(memberId) {
             const member = familyData.members.find(m => m.id === memberId);
             if (!member) return;
             
             currentDeletingId = memberId;
             currentDeletingType = 'member';
             
             document.getElementById('deleteConfirmMessage').innerHTML = 
                 `Are you sure you want to delete <strong>${member.firstName} ${member.lastName}</strong>?<br><br>
                  This will also delete all their subscriptions and statements.`;
             
             openModal('deleteConfirmModal');
         }
         
         function deleteSubscription(subscriptionId) {
             const subscription = familyData.subscriptions.find(s => s.id === subscriptionId);
             if (!subscription) return;
             
             currentDeletingId = subscriptionId;
             currentDeletingType = 'subscription';
             
             const memberName = getMemberName(subscription.memberId);
             document.getElementById('deleteConfirmMessage').innerHTML = 
                 `Are you sure you want to delete the subscription for <strong>${memberName}</strong>?<br><br>
                  Plan: ${subscription.pricePlanTitle}<br>
                  This will also delete all related statements.`;
             
             openModal('deleteConfirmModal');
         }
         
                   function deleteStatement(statementId) {
              const statement = familyData.statements.find(s => s.id === statementId);
              if (!statement) return;
              
              currentDeletingId = statementId;
              currentDeletingType = 'statement';
              
              const memberName = getMemberName(statement.memberId);
              document.getElementById('deleteConfirmMessage').innerHTML = 
                  `Are you sure you want to delete statement #${statement.statementNumber} for <strong>${memberName}</strong>?<br><br>
                   Amount: $${statement.amount}<br>
                   Status: ${statement.status.toUpperCase()}`;
              
              openModal('deleteConfirmModal');
          }

         function deletePricing(planId) {
             const plan = familyData.pricePlans.find(p => p.id === planId);
             if (!plan) return;
             
             currentDeletingId = planId;
             currentDeletingType = 'pricing';
             
             document.getElementById('deleteConfirmMessage').innerHTML = 
                 `Are you sure you want to delete the pricing plan <strong>${plan.title}</strong>?<br><br>
                  Yearly Price: $${plan.yearlyPrice}<br>
                  Monthly Price: $${plan.monthlyPrice}<br>
                  This will also affect any subscriptions using this plan.`;
             
             openModal('deleteConfirmModal');
         }
         
         function confirmDelete() {
             if (!currentDeletingId || !currentDeletingType) return;
             
             switch (currentDeletingType) {
                 case 'member':
                     // Delete member and all related data
                     const memberIndex = familyData.members.findIndex(m => m.id === currentDeletingId);
                     if (memberIndex > -1) {
                         const member = familyData.members[memberIndex];
                         
                         // Delete related subscriptions
                         familyData.subscriptions = familyData.subscriptions.filter(s => s.memberId !== currentDeletingId);
                         
                         // Delete related statements
                         familyData.statements = familyData.statements.filter(s => s.memberId !== currentDeletingId);
                         
                         // Delete the member
                         familyData.members.splice(memberIndex, 1);
                     }
                     break;
                     
                 case 'subscription':
                     // Delete subscription and related statements
                     const subscriptionIndex = familyData.subscriptions.findIndex(s => s.id === currentDeletingId);
                     if (subscriptionIndex > -1) {
                         const subscription = familyData.subscriptions[subscriptionIndex];
                         
                         // Delete related statements
                         familyData.statements = familyData.statements.filter(s => s.subscriptionId !== currentDeletingId);
                         
                         // Delete the subscription
                         familyData.subscriptions.splice(subscriptionIndex, 1);
                     }
                     break;
                     
                 case 'statement':
                     // Delete statement only
                     const statementIndex = familyData.statements.findIndex(s => s.id === currentDeletingId);
                     if (statementIndex > -1) {
                         familyData.statements.splice(statementIndex, 1);
                     }
                     break;
                     
                                   case 'pricing':
                      // Delete pricing plan and update related subscriptions
                      const pricingIndex = familyData.pricePlans.findIndex(p => p.id === currentDeletingId);
                      if (pricingIndex > -1) {
                          const plan = familyData.pricePlans[pricingIndex];
                          
                          // Update subscriptions that use this plan
                          familyData.subscriptions.forEach(sub => {
                              if (sub.pricePlanId === currentDeletingId) {
                                  sub.status = 'inactive';
                                  sub.pricePlanTitle = 'Plan Deleted';
                              }
                          });
                          
                          // Delete the pricing plan
                          familyData.pricePlans.splice(pricingIndex, 1);
                      }
                      break;
                      
                  case 'family':
                      // Delete family from allFamilies list
                      const familyIndex = allFamilies.findIndex(f => f.id === currentDeletingId);
                      if (familyIndex > -1) {
                          allFamilies.splice(familyIndex, 1);
                      }
                      break;
             }
             
                           closeModal('deleteConfirmModal');
              refreshDisplay();
              autoSave(); // Auto-save data
              
              // Success animation
              document.querySelector('.content-header').classList.add('success-animation');
              setTimeout(() => {
                  document.querySelector('.content-header').classList.remove('success-animation');
              }, 500);
         }

         // Export functionality is now in Quick Actions
     </script>
 </body>
 </html>
